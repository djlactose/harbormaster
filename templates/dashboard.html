<!doctype html>
<html>
<head>
  <title>HarborMaster</title>
  <style>
    :root {
      --bg: #f0f4f7;
      --text: #222;
      --card: #fff;
      --border: rgba(0, 0, 0, 0.1);
      --link: #0066cc;
    }
    body.dark {
      --bg: #1e1e1e;
      --text: #ddd;
      --card: #2c2c2c;
      --border: rgba(255, 255, 255, 0.1);
      --link: #66aaff;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: var(--bg);
      color: var(--text);
    }

    h1 { color: var(--text); }
    a { color: var(--link); }

    input[type=text] {
      padding: 6px;
      width: 300px;
    }

    .container-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .container-card {
      width: 260px;
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--border);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .header img.icon {
      height: 32px;
      width: 32px;
    }

    .thumbnail {
      width: 100%;
      height: auto;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .ports {
      margin-top: 5px;
      font-size: 0.85em;
      line-height: 1.4em;
    }

    .image-name {
      font-size: 0.75em;
      color: #999;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
      margin: 0 10px 0 5px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4caf50;
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .switch-label {
      margin-right: 5px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>HarborMaster Dashboard</h1>
  <a href="/settings">⚙️ Legacy Settings</a><br><br>

  <input type="text" id="filterInput" onkeyup="filterContainers()" placeholder="Filter containers...">

  <div style="margin-top: 10px;">
    <label for="refreshSelect">Auto-refresh:</label>
    <select id="refreshSelect">
      <option value="0">Off</option>
      <option value="5">Every 5s</option>
      <option value="10">Every 10s</option>
      <option value="30">Every 30s</option>
      <option value="60">Every 60s</option>
    </select>
    <span id="countdownText" style="margin-left: 10px;"></span>
  </div>

  <div style="margin-top: 15px;">
    <label class="switch-label">Show Stopped</label>
    <label class="switch">
      <input type="checkbox" id="toggleStopped" {% if settings.show_stopped %}checked{% endif %}>
      <span class="slider round"></span>
    </label>

    <label class="switch-label">Show Unmapped</label>
    <label class="switch">
      <input type="checkbox" id="toggleUnmapped" {% if settings.show_unmapped %}checked{% endif %}>
      <span class="slider round"></span>
    </label>

    <label class="switch-label">Dark Mode</label>
    <label class="switch">
      <input type="checkbox" id="toggleDark">
      <span class="slider round"></span>
    </label>
  </div>

  <div class="container-grid">
    {% for c in containers %}
      <div class="container-card">
        <div class="header">
          <img src="{{ c.icon }}" class="icon" alt="icon" onerror="this.src='/static/icons/generic.png'">
          <div>
            <strong>{{ c.name }}</strong><br>
            <div class="image-name">{{ c.image }}</div>
          </div>
        </div>

        {% if c.web_ports %}
          <img class="thumbnail" src="/thumbnail/{{ c.name }}_{{ c.web_ports[0][0] }}">
        {% endif %}

        <div class="ports">
          {% if c.web_ports %}
            <strong>Web Ports:</strong><br>
            {% for p, scheme in c.web_ports %}
              <a href="{{ scheme }}://{{ c.ip }}:{{ p }}" target="_blank">{{ scheme }}://{{ c.ip }}:{{ p }}</a><br>
            {% endfor %}
          {% endif %}
          {% if c.other_ports %}
            <strong>Non-Web Ports:</strong><br>
            {% for p in c.other_ports %}
              {{ c.ip }}:{{ p }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    function setCookie(name, value, days = 365) {
      const expires = new Date(Date.now() + days*864e5).toUTCString();
      document.cookie = `${name}=${value}; path=/; expires=${expires}`;
    }

    function getCookie(name) {
      return document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];
    }

    function updateSetting(field, value) {
      const form = new URLSearchParams();
      form.set(field, value ? "on" : "");
      fetch("/settings", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: form.toString()
      }).then(() => location.reload());
    }

    document.getElementById("toggleStopped").addEventListener("change", function () {
      updateSetting("show_stopped", this.checked);
    });

    document.getElementById("toggleUnmapped").addEventListener("change", function () {
      updateSetting("show_unmapped", this.checked);
    });

    function filterContainers() {
      let input = document.getElementById("filterInput");
      let filter = input.value.toLowerCase();
      let cards = document.getElementsByClassName("container-card");
      for (let card of cards) {
        let name = card.querySelector("strong").innerText.toLowerCase();
        card.style.display = name.includes(filter) ? "" : "none";
      }
    }

    let countdownEl = document.getElementById("countdownText");
    let dropdown = document.getElementById("refreshSelect");

    let refreshRate = parseInt(getCookie("refreshRate") || "10");
    let timeLeft = refreshRate;
    dropdown.value = refreshRate;

    function updateCountdown() {
      if (refreshRate > 0) {
        timeLeft--;
        if (timeLeft <= 0) {
          location.reload();
        } else {
          countdownEl.textContent = `Refreshing in ${timeLeft}s`;
        }
      } else {
        countdownEl.textContent = "Auto-refresh is off";
      }
    }

    dropdown.addEventListener("change", function () {
      refreshRate = parseInt(this.value);
      timeLeft = refreshRate;
      setCookie("refreshRate", refreshRate);
      countdownEl.textContent = refreshRate > 0 ? `Refreshing in ${timeLeft}s` : "Auto-refresh is off";
    });

    function setTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
      setCookie("theme", theme);
    }

    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light";
    }

    function initTheme() {
      let saved = getCookie("theme");
      let theme = saved || getSystemTheme();
      setTheme(theme);
      document.getElementById("toggleDark").checked = (theme === "dark");
    }

    document.getElementById("toggleDark").addEventListener("change", function () {
      setTheme(this.checked ? "dark" : "light");
    });

    initTheme();
    setInterval(updateCountdown, 1000);
  </script>
</body>
</html>
