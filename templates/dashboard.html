<!doctype html>
<html>
<head>
  <title>HarborMaster</title>
  <style>
    :root {
      --bg: #f0f4f7;
      --text: #222;
      --card: #fff;
      --border: rgba(0, 0, 0, 0.1);
      --link: #0066cc;
    }
    body.dark {
      --bg: #1e1e1e;
      --text: #ddd;
      --card: #2c2c2c;
      --border: rgba(255, 255, 255, 0.1);
      --link: #66aaff;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    h1 { margin: 0; }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 1px 5px var(--border);
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header-title { display: flex; align-items: center; gap: 20px; }
    .legacy-link { font-size: 0.9em; }
    .container-grid { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .container-card {
      width: 260px;
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--border);
      display: flex;
      flex-direction: column;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .header img.icon { height: 32px; width: 32px; }
    .thumbnail { width: 100%; height: auto; border-radius: 6px; margin-bottom: 10px; }
    .ports { font-size: 0.85em; line-height: 1.4em; }
    .image-name { font-size: 0.75em; color: #999; }

    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
      margin: 0 10px 0 5px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #4caf50; }
    input:checked + .slider:before { transform: translateX(22px); }
    .switch-label { margin-right: 5px; font-size: 0.9em; }
    .status-dot {
      display: inline-block;
      width: 12px; height: 12px;
      border-radius: 50%;
      margin-right: 4px;
    }
    .status-dot.running { background-color: #4caf50; }
    .status-dot.restarting { background-color: #ffc107; }
    .status-dot.exited,
    .status-dot.dead,
    .status-dot.paused { background-color: #f44336; }
  </style>
</head>
<body>
  <script>
    function setTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
      document.cookie = `theme=${theme}; path=/; max-age=31536000`;
    }
    function getTheme() {
      const match = document.cookie.match(/theme=(dark|light)/);
      return match ? match[1] : (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    }
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = getTheme();
      setTheme(savedTheme);
      document.getElementById("toggleDark").checked = savedTheme === 'dark';
    });
  </script>

  <div class="header-bar">
    <div class="header-title">
      <h1>HarborMaster</h1>
      <a href="/settings" class="legacy-link">⚙️ Settings</a>
    </div>
    <div>
      <label class="switch-label">Show Stopped</label>
      <label class="switch">
        <input type="checkbox" id="toggleStopped" {% if settings.show_stopped %}checked{% endif %}>
        <span class="slider round"></span>
      </label>
      <label class="switch-label">Show Unmapped</label>
      <label class="switch">
        <input type="checkbox" id="toggleUnmapped" {% if settings.show_unmapped %}checked{% endif %}>
        <span class="slider round"></span>
      </label>
      <label class="switch-label">Only Web</label>
      <label class="switch">
        <input type="checkbox" id="toggleOnlyWeb">
        <span class="slider round"></span>
      </label>
      <label class="switch-label">Dark Mode</label>
      <label class="switch">
        <input type="checkbox" id="toggleDark">
        <span class="slider round"></span>
      </label>
    </div>
  </div>

  <div style="margin-bottom: 10px;">
    <input type="text" id="filterInput" onkeyup="filterContainers()" placeholder="Filter containers..." style="padding: 6px; width: 250px;">
  </div>

  <div style="margin-bottom: 10px;">
    <label for="refreshSelect">Auto-refresh:</label>
    <select id="refreshSelect">
      <option value="0">Off</option>
      <option value="5">Every 5s</option>
      <option value="10">Every 10s</option>
      <option value="30">Every 30s</option>
      <option value="60">Every 60s</option>
    </select>
    <span id="countdownText" style="margin-left: 10px;"></span>
  </div>

  <div class="container-grid">
    {% for c in containers %}
      <div class="container-card" data-has-web="{{ 'yes' if c.web_ports else 'no' }}">
        <div class="header">
          <span class="status-dot {{ c.status }}"></span>
          <img src="{{ c.icon }}" class="icon" alt="icon" onerror="this.src='/static/icons/generic.png'">
          <div>
            <strong>{{ c.name }}</strong><br>
            <div class="image-name">{{ c.image }}</div>
          </div>
        </div>
        {% if c.web_ports %}
          <img class="thumbnail" src="/thumbnail/{{ c.name }}_{{ c.web_ports[0][0] }}" onerror="this.style.display='none'">
        {% endif %}
        <div class="ports">
          {% if c.web_ports %}
            <strong>Web Ports:</strong><br>
            {% for p, scheme in c.web_ports %}
              <a href="{{ scheme }}://{{ c.ip }}:{{ p }}" target="_blank">{{ scheme }}://{{ c.ip }}:{{ p }}</a><br>
            {% endfor %}
          {% endif %}
          {% if c.other_ports %}
            <strong>Non-Web Ports:</strong><br>
            {% for p in c.other_ports %}
              {{ c.ip }}:{{ p }}{% if not loop.last %}, {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    function setCookie(name, value, days = 365) {
      const expires = new Date(Date.now() + days*864e5).toUTCString();
      document.cookie = `${name}=${value}; path=/; expires=${expires}`;
    }
    function getCookie(name) {
      return document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];
    }
    function postToggleSettings() {
      const form = new URLSearchParams();
      if (document.getElementById("toggleStopped").checked) form.set("show_stopped", "on");
      if (document.getElementById("toggleUnmapped").checked) form.set("show_unmapped", "on");
      fetch("/settings", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded", "X-Requested-With": "XMLHttpRequest" },
        body: form.toString()
      }).then(() => location.reload());
    }
    document.getElementById("toggleStopped").addEventListener("change", postToggleSettings);
    document.getElementById("toggleUnmapped").addEventListener("change", postToggleSettings);
    document.getElementById("toggleOnlyWeb").addEventListener("change", function () {
      const onlyWeb = this.checked;
      setCookie("onlyWeb", onlyWeb ? "1" : "0");
      filterOnlyWebContainers(onlyWeb);
    });
    function filterOnlyWebContainers(enabled) {
      const cards = document.querySelectorAll('.container-card');
      for (const card of cards) {
        const hasWeb = card.getAttribute('data-has-web') === 'yes';
        card.style.display = (enabled && !hasWeb) ? 'none' : '';
      }
    }
    function initOnlyWebFilter() {
      const saved = getCookie("onlyWeb") === "1";
      document.getElementById("toggleOnlyWeb").checked = saved;
      filterOnlyWebContainers(saved);
    }
    function filterContainers() {
      let input = document.getElementById("filterInput");
      let filter = input.value.toLowerCase();
      let cards = document.getElementsByClassName("container-card");
      for (let card of cards) {
        let name = card.querySelector("strong").innerText.toLowerCase();
        card.style.display = name.includes(filter) ? "" : "none";
      }
    }
    let countdownEl = document.getElementById("countdownText");
    let dropdown = document.getElementById("refreshSelect");
    let refreshRate = parseInt(getCookie("refreshRate") || "10");
    let timeLeft = refreshRate;
    dropdown.value = refreshRate;
    function updateCountdown() {
      if (refreshRate > 0) {
        timeLeft--;
        if (timeLeft <= 0) {
          location.reload();
        } else {
          countdownEl.textContent = `Refreshing in ${timeLeft}s`;
        }
      } else {
        countdownEl.textContent = "Auto-refresh is off";
      }
    }
    dropdown.addEventListener("change", function () {
      refreshRate = parseInt(this.value);
      timeLeft = refreshRate;
      setCookie("refreshRate", refreshRate);
      countdownEl.textContent = refreshRate > 0 ? `Refreshing in ${timeLeft}s` : "Auto-refresh is off";
    });

    document.getElementById("toggleDark").addEventListener("change", function () {
      setTheme(this.checked ? 'dark' : 'light');
    });

    initOnlyWebFilter();
    setInterval(updateCountdown, 1000);
  </script>
</body>
</html>
